# Self_Balancing_Device 제작 계획서

## 프로젝트 개요
자이로 센서와 밸런스 휠 모터를 이용한 모서리 균형 장치 개발 프로젝트
simpleFOC를 사용한 제어. 

## 개발 단계

### Phase 1: 1축 균형 장치 개발 및 하드웨어 설계

#### 보유 하드웨어
- SimpleFOC 컨트롤러(DRV8313) + AS5600 자기각 센서 보드
- 컨트롤러 내장형 모터 (PWM/Direction 제어, 회전수 피드백 출력)
- 컨트롤러 비내장형 모터 (SimpleFOC 연동용)
- GY-87 센서보드 (IMU6050 내장)

#### 개발 계획
1. **1차 테스트: 컨트롤러 내장형 모터**
   - PWM/Direction 제어 방식 구현
   - 회전수 피드백 신호 처리
   - 기본 균형 제어 알고리즘 개발
   
2. **진행 방향**
   - 컨트롤러 내장형 모터로 먼저 테스트 진행
   - 문제가 없으면 해당 모터로 계속 진행
   - 필요시 SimpleFOC 기반 시스템으로 전환 검토

#### MCU 선정
- **ESP32-S3N8R2** 사용
  - MicroPython 기반 개발
  - Dual-core 240MHz (센서 처리 / 모터 제어 병렬 처리)
  - WiFi/BLE 내장 (무선 파라미터 튜닝)
  - Flash 8MB / PSRAM 2MB (프로젝트에 충분)

## 소프트웨어 아키텍처

### 코드 구조 설계 원칙
로직의 개선 및 수정이 용이하도록 구조적으로 모듈화하여 개발합니다.

#### 1. 모듈화 구조
```
main.py                 # 메인 제어 루프
├── config.py          # 설정 파라미터 (튜닝값, 상수)
├── sensors/
│   ├── imu.py        # IMU6050/GY-87 센서 데이터 처리
│   └── filter.py     # 센서 데이터 필터링 (칼만, 상보)
├── motors/
│   ├── motor.py      # 모터 추상화 클래스
│   ├── pwm_motor.py  # PWM/Direction 모터 드라이버
│   └── foc_motor.py  # SimpleFOC 모터 드라이버 (선택)
├── control/
│   ├── pid.py        # PID 제어기
│   └── balance.py    # 균형 제어 로직
└── communication/
    ├── wifi.py       # WiFi 통신
    └── tuning.py     # 실시간 파라미터 조정
```

#### 2. 모터 제어 설계
- **변수 기반 거동 제어**: 모든 모터 파라미터를 외부에서 조정 가능
  - PWM 주파수, 최대/최소 속도, 가속도 제한
  - 응답 특성 조정 변수
- **중앙 집중식 제어**: `MotorController` 클래스가 모든 모터 통합 관리
  - 다중 모터 동기화
  - 안전 모드 (비상 정지, 과부하 보호)

#### 3. 센서-제어 연계
- **센서 데이터 파이프라인**:
  1. IMU 원시 데이터 읽기 (가속도, 자이로)
  2. 필터링 및 융합 (각도 추정)
  3. 제어기로 전달
  4. PID 연산
  5. 모터 명령 생성
- **실시간 처리**: 듀얼코어 활용
  - Core 0: 센서 데이터 수집 및 전처리
  - Core 1: 제어 연산 및 모터 구동

#### 4. 파라미터 관리
- **config.py**: 모든 튜닝 파라미터 중앙 관리
- **실시간 조정**: WiFi/BLE를 통한 원격 수정
- **프로파일 저장**: 축별 설정 저장/불러오기



아두이노에 연결했더니 보드를 몇개씩 날렴먹음. 
5핀 모터 핀아웃
red vdd
blk gnd
blu pwm
green FG

3720 모터는 U1 칩의 8-15번을 연결해야 한다..


타오바오산 모터들은 제어와 회전이 애매하니 (*특히 브레이크)
회로를 별도 제작하면 좋을듯?

어쨋건 이 프로젝트에 쓰기에는 엄청난 개조가 필요하고, 그러려면 별도의 모터와 제어회로가 필요하게 된다
그러면 결국 타오바오 모터에서 abc 상 선만 따서 dengfoc 혹은 simplefoc 드라이버에 연결해서 제어하는게 ?
