# 수학적 이론

# Cubli 2D(Edge) 최소 수학 모델 (교차항 명시 + 올바른 유도)

요구 사항: **현실적 요소 제거**, **순수 동역학(비선형 EoM)** + **세워진(불안정) 평형점 선형화 상태공간 (A,B)**  
상태: `x = [θ, θ̇, ωw]ᵀ` (휠 각도는 포함하지 않음)

---

## 0. 가정

- 큐브: 균질 정육면체, 변 길이 `L`, 질량 `M`
- 운동: 바닥에 고정된 **한 모서리(edge)** 를 축으로 하는 2D(평면) 회전, **1자유도 θ**
- 휠: 큐브 내부 **반작용휠 1개**, 관성 `Jw` (스핀축은 edge 축과 동일)
- 입력: 모터가 휠에 가하는 토크 `τ` (FOC로 토크 직접 지령)
- 마찰/손실/백래시/포화/노이즈: 모두 0
- IMU: 이상적(모델에 센서식 불필요)

---

## 1. 변수/좌표 정의 및 부호 규약

### 1.1 좌표계 선택 (핵심!)
반작용 휠 시스템에서는 좌표 선택이 매우 중요합니다. 다음 두 좌표계를 사용합니다:

**일반화 좌표 (라그랑주 방정식용):**
- `θ` : 큐브의 절대 각도
- `ψ` : 휠의 **상대 각도** (큐브에 대한)
- 관계: `φ = θ + ψ` (휠의 절대 각도)

**상태 변수 (제어용):**
- `θ` : 큐브의 절대 각도
- `θ̇` : 큐브의 각속도
- `ωw = ψ̇` : 휠의 상대 각속도

### 1.2 각도 θ 정의
- `θ(t)` : 큐브가 edge 축을 중심으로 회전한 각도
- **θ = 0** : 큐브가 edge 위에 **세워진 불안정 평형** (COM이 edge 축 바로 위)
- **θ > 0** : 큐브가 한쪽 면으로 **쓰러지는 방향**으로 기울어진 상태  
  → 무제어(τ=0)에서 작은 θ>0는 중력에 의해 더 커지는(불안정) 형태

### 1.3 휠 상대 각속도 ωw 정의
- 휠의 절대 각속도: $\dot{\phi} = \dot{\theta} + \dot{\psi}$
- 휠의 상대 각속도: 
  $$
  \omega_w \triangleq \dot{\psi} = \dot{\phi} - \dot{\theta}
  $$

### 1.4 입력 토크 τ의 의미
- `τ > 0` : 모터가 휠의 **절대 각도 φ를 증가**시키는 방향으로 토크를 가함
- 이것은 내부 토크이므로 전체 시스템의 각운동량은 보존됨

### 1.5 상태벡터
$$
x=\begin{bmatrix}\theta\\ \dot{\theta}\\ \omega_w\end{bmatrix}
$$

---

## 2. 기하학/관성 파라미터(균질 정육면체)

### 2.1 edge 축에서 COM까지 거리
균질 정육면체가 모서리(edge) 위에 서 있을 때, 질량 중심(COM)까지의 거리는:
$$
r=\frac{L}{\sqrt{2}}
$$

### 2.2 큐브의 edge 축 관성모멘트
균질 정육면체의 모서리 축에 대한 관성모멘트는:
$$
I=\frac{2}{3}ML^2
$$

---

## 3. 라그랑지안 유도 (교차항 명시)

### 3.1 운동에너지 (교차항이 명시적으로 보이는 형태)

**큐브의 회전 운동에너지:**
$$
T_{\text{cube}}=\frac{1}{2}I\dot{\theta}^2
$$

**휠의 회전 운동에너지:**
휠의 절대 각속도는 $\dot{\phi} = \dot{\theta} + \dot{\psi}$ 이므로:
$$
T_{\text{wheel}}=\frac{1}{2}J_w\dot{\phi}^2 = \frac{1}{2}J_w(\dot{\theta}+\dot{\psi})^2
$$

**전체 운동에너지:**
$$
T = T_{\text{cube}} + T_{\text{wheel}} = \frac{1}{2}I\dot{\theta}^2+\frac{1}{2}J_w(\dot{\theta}+\dot{\psi})^2
$$

**교차항을 전개:**
$$
\boxed{
T=\frac{1}{2}(I+J_w)\dot{\theta}^2 + J_w\dot{\theta}\dot{\psi} + \frac{1}{2}J_w\dot{\psi}^2
}
$$

여기서 $J_w\dot{\theta}\dot{\psi}$ 항이 **교차항(coupling term)**입니다.

### 3.2 위치에너지
큐브의 COM 높이에 따른 위치에너지 (θ=0에서 최대):
$$
V=Mgr\cos\theta
$$

### 3.3 라그랑지안
$$
\mathcal{L}=T-V = \frac{1}{2}(I+J_w)\dot{\theta}^2 + J_w\dot{\theta}\dot{\psi} + \frac{1}{2}J_w\dot{\psi}^2 - Mgr\cos\theta
$$

---

## 4. 일반화 힘(Generalized Forces) - 핵심 개념!

내부 토크 τ가 일반화 좌표 (θ, ψ)에 미치는 영향을 **가상 일의 원리**로 구합니다.

### 4.1 가상 일 계산
모터가 휠에 토크 τ를 가할 때, 휠의 절대 각도 φ만 변하므로:
$$
\delta W = \tau \cdot \delta\phi
$$

여기서 $\phi = \theta + \psi$ 이므로:
$$
\delta W = \tau \cdot (\delta\theta + \delta\psi)
$$

하지만 **내부 토크는 전체 시스템에 외부 일을 하지 않으므로**, (θ, ψ) 좌표계에서:
$$
\delta W = \tau \cdot \delta\phi - \tau \cdot \delta\theta = \tau \cdot \delta\psi
$$

### 4.2 일반화 힘
$$
\boxed{Q_\theta = 0, \quad Q_\psi = \tau}
$$

**물리적 의미:** 
- 모터 토크는 큐브의 절대 각도 θ에 직접적인 힘을 주지 않습니다
- 오직 휠의 **상대 각도 ψ**만 변화시킵니다
- 큐브의 움직임은 교차항을 통한 **간접적 결합**으로만 영향을 받습니다

---

## 5. 라그랑주 방정식 및 동역학 방정식 유도

### 5.1 라그랑주 방정식 적용

**θ에 대한 운동 방정식:**
$$
\frac{\partial \mathcal{L}}{\partial \dot{\theta}} = (I+J_w)\dot{\theta} + J_w\dot{\psi}
$$
$$
\frac{d}{dt}\frac{\partial \mathcal{L}}{\partial \dot{\theta}} = (I+J_w)\ddot{\theta} + J_w\ddot{\psi}
$$
$$
\frac{\partial \mathcal{L}}{\partial \theta} = Mgr\sin\theta
$$

라그랑주 방정식 $\frac{d}{dt}\frac{\partial \mathcal{L}}{\partial \dot{\theta}} - \frac{\partial \mathcal{L}}{\partial \theta} = Q_\theta$:
$$
(I+J_w)\ddot{\theta} + J_w\ddot{\psi} = Mgr\sin\theta \quad \text{...(1)}
$$

**ψ에 대한 운동 방정식:**
$$
\frac{\partial \mathcal{L}}{\partial \dot{\psi}} = J_w\dot{\theta} + J_w\dot{\psi}
$$
$$
\frac{d}{dt}\frac{\partial \mathcal{L}}{\partial \dot{\psi}} = J_w\ddot{\theta} + J_w\ddot{\psi}
$$
$$
\frac{\partial \mathcal{L}}{\partial \psi} = 0
$$

라그랑주 방정식 $\frac{d}{dt}\frac{\partial \mathcal{L}}{\partial \dot{\psi}} - \frac{\partial \mathcal{L}}{\partial \psi} = Q_\psi$:
$$
J_w(\ddot{\theta} + \ddot{\psi}) = \tau \quad \text{...(2)}
$$

### 5.2 방정식 소거 및 최종 형태

방정식 (2)에서:
$$
\ddot{\psi} = \frac{\tau}{J_w} - \ddot{\theta}
$$

이를 방정식 (1)에 대입:
$$
(I+J_w)\ddot{\theta} + J_w\left(\frac{\tau}{J_w} - \ddot{\theta}\right) = Mgr\sin\theta
$$
$$
I\ddot{\theta} + \tau = Mgr\sin\theta
$$

따라서:
$$
\boxed{\ddot{\theta} = \frac{Mgr}{I}\sin\theta - \frac{1}{I}\tau}
$$

$\dot{\omega}_w = \ddot{\psi}$를 구하면:
$$
\dot{\omega}_w = \frac{\tau}{J_w} - \ddot{\theta} = \frac{\tau}{J_w} - \frac{Mgr}{I}\sin\theta + \frac{1}{I}\tau
$$

$$
\boxed{\dot{\omega}_w = -\frac{Mgr}{I}\sin\theta + \left(\frac{1}{J_w} + \frac{1}{I}\right)\tau}
$$

### 5.3 교차항의 역할 정리

1. **교차항은 존재하며 무시되지 않았습니다**: $J_w\dot{\theta}\dot{\psi}$ 항은 라그랑지안에 명시적으로 포함됨
2. **중간 과정에서 결합**: $(I+J_w)\ddot{\theta} + J_w\ddot{\psi}$ 형태로 두 좌표가 결합
3. **최종 소거**: 두 방정식을 연립하면 $J_w$ 항이 정확히 소거되어 θ 방정식이 단순화됨
4. **물리적 타당성**: 이것은 반작용 휠 시스템의 토크 교환 구조를 정확히 반영

---

## 6. 비선형 동역학 방정식 (최종 형태)
---

## 6. 비선형 동역학 방정식 (최종 형태)

### 6.1 파라미터를 사용한 표현
$$
\boxed{\ddot{\theta}=\frac{Mgr}{I}\sin\theta-\frac{1}{I}\tau}
$$
$$
\boxed{\dot{\omega}_w=-\frac{Mgr}{I}\sin\theta+\left(\frac{1}{J_w}+\frac{1}{I}\right)\tau}
$$

### 6.2 L, M으로 완전히 전개한 형태
$r=\frac{L}{\sqrt{2}}$, $I=\frac{2}{3}ML^2$를 대입하면:

$$
\boxed{\ddot{\theta}=\frac{3g}{2\sqrt{2}L}\sin\theta-\frac{3}{2ML^2}\tau}
$$
$$
\boxed{\dot{\omega}_w=-\frac{3g}{2\sqrt{2}L}\sin\theta+\left(\frac{1}{J_w}+\frac{3}{2ML^2}\right)\tau}
$$

### 6.3 상태공간 형태
$$
\dot{x}=f(x,\tau)=
\begin{bmatrix}
\dot{\theta}\\
\frac{Mgr}{I}\sin\theta-\frac{1}{I}\tau\\
-\frac{Mgr}{I}\sin\theta+\left(\frac{1}{J_w}+\frac{1}{I}\right)\tau
\end{bmatrix}
$$

---

## 7. 평형점 및 선형화 (세워진 불안정 균형)

### 7.1 평형점
세워진 상태의 평형점:
$$
x^* = \begin{bmatrix}0\\ 0\\ 0\end{bmatrix}, \quad \tau^* = 0
$$

### 7.2 선형화
평형점 근처에서 $\sin\theta \approx \theta$로 선형화하면:

편의상 다음과 같이 정의:
$$
a \triangleq \frac{Mgr}{I} = \frac{3g}{2\sqrt{2}L}, \quad b \triangleq \frac{1}{I} = \frac{3}{2ML^2}
$$

선형화된 시스템:
$$
\dot{x} = Ax + Bu
$$

여기서:
$$
\boxed{
A=
\begin{bmatrix}
0 & 1 & 0\\
a & 0 & 0\\
-a & 0 & 0
\end{bmatrix}
=
\begin{bmatrix}
0 & 1 & 0\\
\frac{3g}{2\sqrt{2}L} & 0 & 0\\
-\frac{3g}{2\sqrt{2}L} & 0 & 0
\end{bmatrix}
}
$$

$$
\boxed{
B=
\begin{bmatrix}
0\\
-b\\
\frac{1}{J_w}+b
\end{bmatrix}
=
\begin{bmatrix}
0\\
-\frac{3}{2ML^2}\\
\frac{1}{J_w}+\frac{3}{2ML^2}
\end{bmatrix}
}
$$

### 7.3 안정성 분석
행렬 A의 고유값을 구하면:
$$
\det(\lambda I - A) = \lambda^3 - a\lambda = \lambda(\lambda^2 - a) = 0
$$

고유값:
$$
\lambda_1 = 0, \quad \lambda_2 = \sqrt{a} = \sqrt{\frac{3g}{2\sqrt{2}L}}, \quad \lambda_3 = -\sqrt{a}
$$

**양의 실수 고유값**이 존재하므로 평형점은 **불안정(unstable)**합니다.

### 7.4 제어가능성(Controllability)
제어가능성 행렬:
$$
\mathcal{C} = [B \;\; AB \;\; A^2B]
$$

$$
\det(\mathcal{C}) = \frac{a}{I^2J_w} = \frac{3g}{2\sqrt{2}L} \cdot \frac{9}{4M^2L^4J_w} \neq 0
$$

따라서:
$$
\boxed{(A,B) \text{는 제어가능(controllable)}}
$$

이는 적절한 제어기(LQR, Pole Placement 등)를 설계하여 불안정한 평형점을 안정화시킬 수 있음을 의미합니다.

---

## 8. 요약

### 8.1 핵심 포인트
1. **교차항의 존재**: 라그랑지안에 $J_w\dot{\theta}\dot{\psi}$ 교차항이 명시적으로 포함
2. **좌표 선택의 중요성**: (θ, ψ) 좌표계 선택으로 일반화 힘이 $Q_\theta=0$, $Q_\psi=\tau$로 단순화
3. **자연스러운 소거**: 연립 방정식 해결 과정에서 교차항이 물리적으로 타당하게 소거
4. **제어 가능성**: 불안정하지만 완전히 제어 가능한 시스템

### 8.2 설계 파라미터
- 큐브 질량 `M`, 크기 `L`: 기계적 설계
- 휠 관성 `Jw`: 휠 선택 (큰 값일수록 제어 권한 증가)
- 모터 토크 `τ`: 제어 입력 (FOC 기반 토크 제어)

### 8.3 다음 단계
- LQR 또는 극점 배치를 통한 제어기 설계
- 센서 노이즈를 고려한 칼만 필터 설계
- 2축, 3축으로의 확장
